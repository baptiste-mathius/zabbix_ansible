---
- name: Déploiement de la base de données Zabbix
  hosts: zabbix_db_servers
  become: yes
  vars:
    mysql_root_password: "secure_root_password"
    zabbix_db_name: zabbix
    zabbix_db_user: zabbix
    zabbix_db_password: "secure_zabbix_db_password"
  
  roles:
    - role: geerlingguy.mysql
      tags: mysql
      mysql_databases:
        - name: "{{ zabbix_db_name }}"
          encoding: utf8
          collation: utf8_bin
      mysql_users:
        - name: "{{ zabbix_db_user }}"
          host: "%"
          password: "{{ zabbix_db_password }}"
          priv: "{{ zabbix_db_name }}.*:ALL"

- name: Installation de Zabbix Server LTS
  hosts: zabbix_servers
  become: yes
  vars:
    zabbix_server_version: 7.0
    zabbix_server_dbtype: mysql
    zabbix_server_dbhost: "{{ hostvars['zabbix_db_servers'][0]['ansible_host'] }}"
    zabbix_server_dbname: "{{ zabbix_db_name }}"
    zabbix_server_dbuser: "{{ zabbix_db_user }}"
    zabbix_server_dbpassword: "{{ zabbix_db_password }}"
    zabbix_url: http://{{ ansible_host }}/zabbix
  
  roles:
    - role: community.zabbix.zabbix_server
      tags: zabbix_server

